name: CI
on:
  workflow_dispatch:
  push:
    paths: [ 'optimi/**', 'tests/**' ]
  pull_request:
    paths: [ 'optimi/**', 'tests/**' ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Python and uv with caching
        uses: astral-sh/setup-uv@v6
        with:
          version: "0.7.13" # for reproducibility
          python-version: ${{ matrix.python-version }}
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Install optimi
        run: uv sync --group cpu

      # - name: Ruff Check
      #   id: ruff
      #   run: |
      #     ruff check --output-format=github .
      #     ruff format --check .

      - name: Run Tests
        id: pytest
        run: |
          REPORT="$(mktemp)"
          echo "report-path=$REPORT" >> $GITHUB_OUTPUT
          pytest -v -m cpu --md=$REPORT

      # Modified from https://github.com/pavelzw/pytest-action, MIT License
      - name: Add report to summary
        run: |
          echo "::group::..."
          FINAL_REPORT="$(mktemp)"
          echo "# Pytest Report" > "$FINAL_REPORT"
          echo "<details><summary>Click to expand!</summary>" >> "$FINAL_REPORT"
          tail -n+2 "${{ steps.pytest.outputs.report-path }}" >> "$FINAL_REPORT"
          echo "</details>" >> "$FINAL_REPORT"
          cat "$FINAL_REPORT" >> "$GITHUB_STEP_SUMMARY"
          echo "::endgroup::"
          echo
          echo "====================================================================================="
          echo Markdown summaries: "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          echo "====================================================================================="